---
title: 'middleware ê°€ ë­ì˜ˆìš”'
date: 2025-05-11
desc: ê·¸ê²Œ ë­ì˜ˆìš”?
thumbnail: /team-member-1.jpeg
category: middleware
open: true
---

## ë“¤ì–´ê°€ëŠ” ê¸€

ìµœê·¼ì— API-Gateway ì—ì„œ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ë¶€ë¶„ì„ ë¦¬íŒ©í† ë§í•˜ë©´ì„œ ì´ìƒì ì¸ ë¯¸ë“¤ì›¨ì–´ëŠ” ì–´ë–¤ ëª¨ìŠµì¸ì§€ ê³ ë¯¼í•˜ê²Œ ëë‹¤.
ì˜ˆì‹œë¡œ ì‘ì„±ëœ **As-Is**, **To-Be** ì½”ë“œë¥¼ ë¹„êµí•˜ë©´ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¯¸ë“¤ì›¨ì–´ ë‹µê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì•Œì•„ë³´ì.

## ğŸŒ ë¯¸ë“¤ì›¨ì–´(Middleware)ë€ ë¬´ì—‡ì¸ê°€?

`ë¯¸ë“¤ì›¨ì–´(Middleware)`ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­(Request)ê³¼ ì„œë²„ì˜ ì‘ë‹µ(Response) ì‚¬ì´ì— ìœ„ì¹˜í•œ **ì¤‘ê°„ ì²˜ë¦¬ ê³„ì¸µ**ìœ¼ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ì´ë¥¼ ê°€ë¡œì±„ **ë¬´ì–¸ê°€ë¥¼** ì²˜ë¦¬í•œ ë’¤, ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ê¸°ëŠ” **í•¨ìˆ˜**ë‹¤.
ë¯¸ë“¤ì›¨ì–´ëŠ” í•˜ë‚˜ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ì „ì—, í˜¹ì€ ì²˜ë¦¬ê°€ ëë‚œ í›„ì— ë‹¤ì–‘í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•œë‹¤.

> - ì¸ì¦(Authentication)
> - ê¶Œí•œ ê²€ì‚¬(Authorization)
> - ë¡œê¹…(Logging)
> - íŠ¸ë ˆì´ì‹±(Tracing)
> - CORS ì²˜ë¦¬
> - ìš”ì²­/ì‘ë‹µ ê°€ê³µ: í—¤ë” ì¶”ê°€, íŒŒë¼ë¯¸í„° ìˆ˜ì • ë“±

ì´ì²˜ëŸ¼ ë¯¸ë“¤ì›¨ì–´ëŠ” ìš”ì²­ê³¼ ì‘ë‹µ íë¦„ì„ ì œì–´í•˜ë©°, ì½”ë“œì˜ ì¬ì‚¬ìš©ì„±ê³¼ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë¡œ ë™ì‘í•œë‹¤.
ë¯¸ë“¤ì›¨ì–´ê°€ ì–´ë–¤ ìƒí™©ì—ì„œ ì‚¬ìš©ë˜ëŠ”ì§€ëŠ” ê°„ë‹¨íˆ ì•Œì•„ë´¤ë‹¤. ê·¸ëŸ¼ ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” ì–´ë–»ê²Œ êµ¬ì„±í•˜ëŠ”ê²Œ ë°”ëŒì§í• ê¹Œ?
ìš°ì„  ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ì‹ì€ Go ì–¸ì–´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í¬ê²Œ í•¨ìˆ˜í˜•(functional)ê³¼ êµ¬ì¡°ì²´ ê¸°ë°˜(object-oriented)ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.

## ì½”ë“œë¡œ ì•Œì•„ë³´ëŠ” ë¯¸ë“¤ì›¨ì–´

#### AS-IS

ì•„ë˜ëŠ” ì¸ì¦ì„ ë‹´ë‹¹í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ ì½”ë“œë‹¤. authenticate ë³€ìˆ˜ì— ì¸ì¦ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì£¼ì…í•˜ì—¬ Authenticate() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ì„ ì²˜ë¦¬í•œë‹¤.
ë¯¸ë“¤ì›¨ì–´ê°€ ë¬´ì—‡ì¸ì§€ ì •í™•íˆ ì•Œê¸° ì „ê¹Œì§€ëŠ” ê²‰ë³´ê¸°ì— ë¬¸ì œê°€ ì—†ëŠ” ì½”ë“œë¼ ìƒê°í–ˆë‹¤.
í•˜ì§€ë§Œ ì½”ë“œë¦¬ë·°ì—ì„  ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¯¸ë“¤ì›¨ì–´ ë‹µê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ëŠ” í”¼ë“œë°±ì„ ë°›ì•˜ë‹¤.
ê·¸ ë•Œ ê¹Œì§€ë§Œ í•´ë„ ë¯¸ë“¤ì›¨ì–´ê°€ ì–´ë–¤ ì—­í• ì„ í•˜ëŠ”ì§€ ëª…í™•íˆ ëª°ëê¸°ì— ë¬´ì—‡ì„ ê³ ì³ì•¼ í•˜ëŠ”ì§€ ëª¨í˜¸í–ˆë‹¤.

```go
func Router(e *echo.Echo, endpoint string, authClientConn *grpc.ClientConn) {
    ...
	authenticate := middlewares.NewAuthMiddleware(nonTokenAuth, headerTokenAuth, anonymousAuth)
	buildMiddlewares := func() []echo.MiddlewareFunc {
		return []echo.MiddlewareFunc{
            ...
            authenticate.Authenticate(),
            ...
		}
	}
}

```

```go
type AuthMiddleware struct {
	authenticators []Authenticator
}

func NewAuthMiddleware(authenticators ...Authenticator) *AuthMiddleware {
	return &AuthMiddleware{
		authenticators: authenticators,
	}
}

// Authenticate returns a middleware function that handles authentication
func (m *AuthMiddleware) Authenticate() func(next echo.HandlerFunc) echo.HandlerFunc {
	return func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(ec echo.Context) error {
			req := ec.Request()
			ctx := req.Context()
			...
			return echo.NewHTTPError(http.StatusUnauthorized, "Authentication failed")
		}
	}
}
```

#### TO-BE

As-Is ì½”ë“œì™€ ë¹„êµí•˜ë©´ ì–´ë–¤ ì°¨ì´ê°€ ìˆëŠ”ì§€ ì‚´í´ë³´ì.
ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” AuthMiddleware êµ¬ì¡°ì²´ë¥¼ ì •ì˜í•˜ê³  NewAuthMiddleware (ìƒì„±ì) í•¨ìˆ˜ë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±, Authenticate() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ê¸°ëŠ¥ì„ ì¶”ê°€í–ˆë‹¤. ì¸ì¦ ì´ë€ ì¤‘ê°„ ì²˜ë¦¬ ì‘ì—…ì„ ìœ„í•´ í•˜ë‚˜ì˜ êµ¬ì¡°ì²´ì™€ ë‘ê°œì˜ ë©”ì„œë“œë¥¼ ì¶”ê°€í–ˆë‹¤.
ë°˜ë©´ To-Be ì½”ë“œëŠ” ê½¤ë‚˜ ê°„ê²°í•´ì§„ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì• ì´ˆì— AuthMiddleware êµ¬ì¡°ì²´ë„, ìƒì„±ì í•¨ìˆ˜ë„ ì •ì˜í•˜ì§€ ì•Šì•˜ë‹¤. ì˜¤ì§ ì¸ì¦ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ í•¨ìˆ˜ë§Œ ì •ì˜í–ˆë‹¤.
ì½”ë“œê°€ ê°„ê²°í•´ì¡Œê³  `buildMiddlewares` í•¨ìˆ˜ì—ì„œë„ ë³„ë„ë¡œ `authenticate.Authenticate()` ì²˜ëŸ¼ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ê·¸ì € authenticate ë¯¸ë“¤ì›¨ì–´ë¥¼ ë„˜ê¸¸ ë¿ì´ë‹¤.
ì™œ To-Be ì²˜ëŸ¼ ì‘ì„±í•˜ëŠ”ê²Œ ë” ë‚˜ì€ ë°©ì‹ì¼ê¹Œ? ì´ëŠ” ë” ë‚˜ì€ ë°©ì‹ì´ë¼ê¸° ë³´ë‹¤ ë¯¸ë“¤ì›¨ì–´ì„ ë¯¸ë“¤ì›¨ì–´ ë‹µê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë¼ í‘œí˜„í•˜ëŠ” ê²ƒì´ ë§ê² ë‹¤.

```go
func Router(e *echo.Echo, endpoint string, authClientConn *grpc.ClientConn) {
    ...
	authenticate := middlewares.NewAuthMiddlewareV2(nonTokenAuth, headerTokenAuth, anonymousAuth)
	buildMiddlewares := func() []echo.MiddlewareFunc {
		return []echo.MiddlewareFunc{
			authenticate, // ì´ì „ê³¼ ë‹¬ë¦¬ ë‹¨ìˆœíˆ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë„˜ê¸°ë©´ ëœë‹¤.
		}
	}
}
```

```go
func NewAuthMiddlewareV2(authenticators ...Authenticator) func(next echo.HandlerFunc) echo.HandlerFunc {
	return func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(ec echo.Context) error {
			req := ec.Request()
			ctx := req.Context()
            ...
			return echo.NewHTTPError(http.StatusUnauthorized, "Authentication failed")
		}
	}
}
```

## ì™œ ì´ë ‡ê²Œ ì¨ì•¼ í•˜ëŠ”ì§€?

## ë§ºëŠ” ë§
